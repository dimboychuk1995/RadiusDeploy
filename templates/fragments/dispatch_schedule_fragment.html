<div class="text-center my-3">
  <div class="btn-group" role="group" id="weekNav">
    <button type="button" class="btn btn-primary btn-sm" id="prevWeekBtn">Previous week</button>
    <button type="button" class="btn btn-info btn-sm" id="currentWeekBtn">Current week</button>
    <button type="button" class="btn btn-primary btn-sm" id="nextWeekBtn">Next week</button>
  </div>
</div>

<div class="text-center mb-3">
  <strong id="weekRangeLabel" class="fs-6"></strong>
</div>

<div id="dispatch-table-wrapper">
  <table class="table table-bordered table-sm text-center align-middle w-100">
    <thead class="table-light">
      <tr>
        <th style="width: 12%;">Driver</th>
        <th style="width: 10%;">Phone</th>
        <th style="width: 6%;">Truck</th>
        <th style="width: 6%;">Trailer</th>
        {% for i in range(7) %}
          <th style="width: 9%;">
            <span class="day-label-placeholder">{{ current_week_dates[i].strftime("%m/%d/%Y") }}</span><br>
            <span class="day-name-placeholder">{{ current_week_dates[i].strftime("%A") }}</span><br>
            <a href="#">Send list</a>
          </th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for dispatcher in dispatchers %}
        <tr class="table-dark dispatcher-header" data-dispatcher="{{ dispatcher.id }}" style="cursor: pointer;">
          <td colspan="11">{{ dispatcher.username }}</td>
        </tr>
        {% for driver in drivers if driver.dispatcher == dispatcher.id %}
          <tr class="driver-row" data-dispatcher="{{ dispatcher.id }}" data-driver-id="{{ driver.id }}">
            <td>{{ driver.name }}</td>
            <td>{{ driver.contact_number or '' }}</td>
            <td>{{ driver.truck_info.unit_number or 'no truck' }}</td>
            <td><!-- Trailer --></td>
            {% for i in range(7) %}
              {% set date_str = current_week_dates[i].strftime("%m/%d/%Y") %}
              {% set deliveries = driver_delivery_map.get((driver.id, date_str), []) %}
              {% set breaks = driver_break_map.get((driver.id, date_str)) %}
              <td class="load-cell" data-day="{{ i }}">
                {% if deliveries|length == 1 %}
                  {{ deliveries[0].location }}
                  {% if deliveries[0].price is not none and deliveries[0].is_last %}
                    ({{ '${:,.2f}'.format(deliveries[0].price) }})
                  {% endif %}
                  <span class="delivery-item d-none"
                        data-load-id="{{ deliveries[0].load_id }}"
                        data-driver-id="{{ driver.id }}"
                        {% if deliveries[0].price is not none and deliveries[0].is_last %}
                          data-amount="{{ deliveries[0].price }}"
                        {% endif %}></span>
                {% elif deliveries|length > 1 %}
                  <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle w-100" type="button" data-bs-toggle="dropdown">
                      {{ deliveries|length }} deliveries
                    </button>
                    <ul class="dropdown-menu text-start">
                      {% for d in deliveries %}
                        <li>
                          <a class="dropdown-item delivery-item"
                             href="#"
                             data-load-id="{{ d.load_id }}"
                             data-driver-id="{{ driver.id }}"
                             {% if d.price is not none and d.is_last %}
                               data-amount="{{ d.price }}"
                             {% endif %}>
                            {{ d.location }}
                            {% if d.price is not none and d.is_last %}
                              ({{ '${:,.2f}'.format(d.price) }})
                            {% endif %}
                          </a>
                        </li>
                      {% endfor %}
                    </ul>
                  </div>
                {% endif %}

                {% if breaks %}
                  <div class="text-danger fw-bold" title="{{ breaks|join(', ') }}">///\\\</div>
                {% endif %}
              </td>
            {% endfor %}
          </tr>
        {% endfor %}
      {% endfor %}
    </tbody>
  </table>
</div>



<!-- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é -->
<div id="driverContextMenu" class="dropdown-menu" style="position: absolute; display: none; z-index: 9999;">
  <button class="dropdown-item" id="setBreakBtn">–ù–∞–∑–Ω–∞—á–∏—Ç—å –±—Ä–µ–π–∫</button>
  <button class="dropdown-item" id="showOnMapBtn">–í–æ–¥–∏—Ç–µ–ª—å –Ω–∞ –∫–∞—Ä—Ç–µ</button>
</div>

<!-- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –¥–ª—è –≥—Ä—É–∑–æ–≤ -->
<div id="loadContextMenu" class="position-absolute bg-white border shadow-sm rounded px-2 py-1"
     style="display: none; z-index: 9999;">
  <button class="dropdown-item text-danger" id="excludeFromGrossBtn">–ù–µ —É—á–∏—Ç—ã–≤–∞—Ç—å –≤ –≥—Ä–æ—Å—Å —ç—Ç–æ–π –Ω–µ–¥–µ–ª–∏</button>
  <button class="dropdown-item text-primary" id="consolidateLoadsBtn">–ö–æ–Ω—Å–æ–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –≥—Ä—É–∑—ã</button>
</div>


<!-- ============== –ú–æ–¥–∞–ª–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –±—Ä–µ–π–∫–∞ –≤–æ–¥–∏—Ç–µ–ª—é ============== -->
<div class="custom-offcanvas custom-offcanvas-right" id="driverBreakModalDispatch">
  <div class="custom-offcanvas-content">
    <div class="custom-offcanvas-header">
      <h4>–ù–∞–∑–Ω–∞—á–∏—Ç—å –ø–µ—Ä–µ—Ä—ã–≤ –≤–æ–¥–∏—Ç–µ–ª—é</h4>
      <button class="btn btn-sm btn-secondary" onclick="closeDriverBreakModalDispatch()">‚úñ</button>
    </div>
    <div class="custom-offcanvas-body">
      <div class="load-modal-content">
        <div class="load-modal-left" style="width: 100%;">
          <form id="driverBreakFormDispatch">
            <div class="mb-3">
              <label for="breakReasonDispatch" class="form-label">–ü—Ä–∏—á–∏–Ω–∞</label>
              <select id="breakReasonDispatch" class="form-select">
                <option value="–†–µ–º–æ–Ω—Ç">–†–µ–º–æ–Ω—Ç</option>
                <option value="–û—Ç–ø—É—Å–∫">–û—Ç–ø—É—Å–∫</option>
                <option value="–í—ã—Ö–æ–¥–Ω—ã–µ">–í—ã—Ö–æ–¥–Ω—ã–µ</option>
                <option value="Supervision">Supervision</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="breakDateRangeDispatch" class="form-label">–î–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç</label>
              <input type="text" id="breakDateRangeDispatch" class="form-control" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—ã">
            </div>
            <div class="text-end mt-4">
              <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ -->
<div class="custom-offcanvas-backdrop" id="driverBreakBackdropDispatch" onclick="closeDriverBreakModalDispatch()"></div>


<!-- ============== –ú–æ–¥–∞–ª–∫–∞ –∫–æ–Ω—Å–æ–ª–∏–¥–∞—Ü–∏–∏ –≥—Ä—É–∑–æ–≤ (DISPATCH) ============== -->
<div class="custom-offcanvas custom-offcanvas-right" id="consolidationModalDispatch">
  <div class="custom-offcanvas-content">
    <div class="custom-offcanvas-header">
      <h4>–ö–æ–Ω—Å–æ–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –≥—Ä—É–∑—ã</h4>
      <button class="btn btn-sm btn-secondary" onclick="closeConsolidationModalDispatch()">‚úñ</button>
    </div>

    <!-- ‚úÖ –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É, —á—Ç–æ–±—ã –Ω–µ —Ç—è–Ω—É–ª–æ –≤–Ω–∏–∑ -->
    <div class="custom-offcanvas-body" style="max-height: 90vh; overflow-y: auto; padding: 16px 24px 20px 24px;">

      <!-- üìå –í–ª–æ–∂–µ–Ω–Ω—ã–π –±–ª–æ–∫ –±–µ–∑ flex, –ø—Ä–æ—Å—Ç–æ –ø–æ –ø–æ—Ç–æ–∫—É -->
      <div class="mb-3">
        <div class="d-flex justify-content-between" style="gap: 4%;">
          <div style="width: 48%;">
            <h6>–ü–∏–∫–∞–ø—ã</h6>
            <ul id="pickupListDispatch" class="list-group sortable-list"></ul>
          </div>
          <div style="width: 48%;">
            <h6>–î–æ—Å—Ç–∞–≤–∫–∏</h6>
            <ul id="deliveryListDispatch" class="list-group sortable-list"></ul>
          </div>
        </div>
      </div>

      <!-- üìå –¢–∞–±–ª–∏—Ü–∞ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ -->
      <div class="mb-3">
        <h6>–ì—Ä—É–∑—ã</h6>
        <div class="table-responsive">
          <table class="table table-bordered table-sm text-center bg-white" id="consolidatedLoadsTable">
            <thead class="table-light">
              <tr>
                <th>ID</th>
                <th>Broker</th>
                <th>Pickup</th>
                <th>Delivery</th>
                <th>RPM</th>
                <th>–¶–µ–Ω–∞</th>
              </tr>
            </thead>
            <tbody id="consolidatedLoadsBody">
              <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JS -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- üìå –ö–Ω–æ–ø–∫–∞ —Å—Ä–∞–∑—É –ø–æ–¥ —Ç–∞–±–ª–∏—Ü–µ–π -->
      <div class="text-end">
        <button id="saveConsolidationBtnDispatch" class="btn btn-success" style="display: none;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>

    </div>
  </div>
</div>

<!-- –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ -->
<div class="custom-offcanvas-backdrop" id="consolidationBackdropDispatch" onclick="closeConsolidationModalDispatch()"></div>

