<h1>–î–µ—Ç–∞–ª–∏ –≥—Ä—É–∑–∞</h1>

<button class="btn btn-secondary mb-3" onclick="returnToLoads()">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É –≥—Ä—É–∑–æ–≤</button>

<div class="container-fluid">
  <div class="row">
    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
    <div class="col-md-6">
      <!-- –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
      <div class="card mb-4">
        <div class="card-header">–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
        <div class="card-body">
          <p><strong>Load ID:</strong> {{ load.load_id or "‚Äî" }}</p>
          <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> {{ load.load_description or "‚Äî" }}</p>
          <p><strong>–¢–∏–ø:</strong> {{ load.type or "‚Äî" }}</p>
          <p><strong>–í–µ—Å:</strong> {{ load.weight or "‚Äî" }}</p>
          <p><strong>–û–±—â–∏–µ –º–∏–ª–∏:</strong> {{ load.total_miles or "‚Äî" }}</p>
          <p><strong>–¶–µ–Ω–∞:</strong> ${{ load.price or "‚Äî" }}</p>
          <p><strong>RPM:</strong> ${{ load.RPM or "‚Äî" }}</p>
          <p><strong>–°—Ç–∞—Ç—É—Å:</strong> {{ load.status or "‚Äî" }}</p>
          <p><strong>–û–ø–ª–∞—Ç–∞:</strong> {{ load.payment_status or "‚Äî" }}</p>
          <p><strong>–ë—ã–ª –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å—Ç–µ–π—Ç–º–µ–Ω—Ç:</strong> {{ "–î–∞" if load.was_added_to_statement else "–ù–µ—Ç" }}</p>
        </div>
      </div>

      <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±—Ä–æ–∫–µ—Ä–µ -->
      <div class="card mb-4">
        <div class="card-header">–ë—Ä–æ–∫–µ—Ä</div>
        <div class="card-body">
          <p><strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> {{ load.broker_load_id or "‚Äî" }}</p>
          <p><strong>–¢–∏–ø:</strong> {{ load.broker_customer_type or "‚Äî" }}</p>
          <p><strong>Email:</strong> {{ load.broker_email or "‚Äî" }}</p>
          <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> {{ load.broker_phone_number or "‚Äî" }}</p>
        </div>
      </div>

      <!-- –î–æ–∫—É–º–µ–Ω—Ç—ã —Å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–º -->
      <div class="card mb-2">
            <div class="card-header" data-bs-toggle="collapse" href="#rateConCollapse" role="button" aria-expanded="false" aria-controls="rateConCollapse">
              üìÑ Rate Con
            </div>
            <div id="rateConCollapse" class="collapse">
              <div class="card-body">
                {% if load.rate_con %}
                  <iframe src="/api/load/{{ load._id }}/ratecon" width="100%" height="1000px" style="border-radius: 8px; border: 1px solid #ccc;"></iframe>
                {% else %}
                  <p>Rate Con –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω</p>
                {% endif %}
              </div>
            </div>
          </div>

          <div class="card mb-2">
            <div class="card-header" data-bs-toggle="collapse" href="#bolCollapse" role="button" aria-expanded="false" aria-controls="bolCollapse">
              üìÑ BOL
            </div>
            <div id="bolCollapse" class="collapse">
              <div class="card-body">
                {% if load.bol %}
                  <iframe src="/api/load/{{ load._id }}/bol" width="100%" height="1000px" style="border-radius: 8px; border: 1px solid #ccc;"></iframe>
                {% else %}
                  <p>BOL –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω</p>
                {% endif %}
              </div>
            </div>
          </div>

    </div>

    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
    <div class="col-md-6">
      {% set pickups = [load.pickup] + (load.extra_pickup or []) %}
      {% set deliveries = [load.delivery] + (load.extra_delivery or []) %}

      {% for p in pickups %}
      <div class="card mb-2">
        <div class="card-header" data-bs-toggle="collapse" href="#pickupCollapse{{ loop.index }}" role="button" aria-expanded="false" aria-controls="pickupCollapse{{ loop.index }}">
          Pickup {{ loop.index }} ‚Äî {{ p.company or "‚Äî" }}, {{ p.address or "‚Äî" }}
        </div>
        <div id="pickupCollapse{{ loop.index }}" class="collapse">
          <div class="card-body">
            <p><strong>–ö–æ–º–ø–∞–Ω–∏—è:</strong> {{ p.company or "‚Äî" }}</p>
            <p><strong>–ê–¥—Ä–µ—Å:</strong> {{ p.address or "‚Äî" }}</p>
            <p><strong>–î–∞—Ç–∞:</strong> {{ p.date or "‚Äî" }}</p>
            <p><strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:</strong> {{ p.instructions or "‚Äî" }}</p>
            <p><strong>–ö–æ–Ω—Ç–∞–∫—Ç:</strong> {{ p.contact_person or "‚Äî" }} / {{ p.contact_phone_number or "‚Äî" }}</p>
          </div>
        </div>
      </div>
      {% endfor %}

      {% for d in deliveries %}
      <div class="card mb-2">
        <div class="card-header" data-bs-toggle="collapse" href="#deliveryCollapse{{ loop.index }}" role="button" aria-expanded="false" aria-controls="deliveryCollapse{{ loop.index }}">
          Delivery {{ loop.index }} ‚Äî {{ d.company or "‚Äî" }}, {{ d.address or "‚Äî" }}
        </div>
        <div id="deliveryCollapse{{ loop.index }}" class="collapse">
          <div class="card-body">
            <p><strong>–ö–æ–º–ø–∞–Ω–∏—è:</strong> {{ d.company or "‚Äî" }}</p>
            <p><strong>–ê–¥—Ä–µ—Å:</strong> {{ d.address or "‚Äî" }}</p>
            <p><strong>–î–∞—Ç–∞:</strong> {{ d.date or "‚Äî" }}</p>
            <p><strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:</strong> {{ d.instructions or "‚Äî" }}</p>
            <p><strong>–ö–æ–Ω—Ç–∞–∫—Ç:</strong> {{ d.contact_person or "‚Äî" }} / {{ d.contact_phone_number or "‚Äî" }}</p>
          </div>
        </div>
      </div>
      {% endfor %}

      <!-- –ö–∞—Ä—Ç–∞ -->
      <div id="loadMapWrapper"
           data-mapbox-token="{{ mapbox_token }}"
           data-pickup-address="{{ load.pickup.address | escape }}"
           data-delivery-address="{{ load.delivery.address | escape }}"
           data-extra-pickups='{{ (load.extra_pickup or []) | tojson | safe }}'
           data-extra-deliveries='{{ (load.extra_delivery or []) | tojson | safe }}'>

        <div class="card mb-4">
          <div class="card-header" data-bs-toggle="collapse" href="#mapCollapse" role="button" aria-expanded="true" aria-controls="mapCollapse">
            –ú–∞—Ä—à—Ä—É—Ç
          </div>
          <div id="mapCollapse" class="collapse show">
            <div class="card-body">
              <div id="loadMap" style="height: 400px; border-radius: 8px;"></div>
            </div>
          </div>
        </div>
      </div>

      {% set extra_pickups = load.extra_pickup or [] %}
      {% set extra_deliveries = load.extra_delivery or [] %}
      {% set total_stops = 1 + extra_pickups | length + 1 + extra_deliveries | length %}

      {% for stop_number in range(total_stops) %}
        {% if stop_number == 0 %}
          {% set label = "–§–æ—Ç–æ —Å Pickup" %}
          {% set stage = "pickup" %}
        {% elif stop_number <= extra_pickups | length %}
          {% set label = "–§–æ—Ç–æ —Å Extra Pickup #" ~ stop_number %}
          {% set stage = "extra_pickup" %}
        {% elif stop_number == extra_pickups | length + 1 %}
          {% set label = "–§–æ—Ç–æ —Å Delivery" %}
          {% set stage = "delivery" %}
        {% else %}
          {% set extra_index = stop_number - (extra_pickups | length + 2) %}
          {% set label = "–§–æ—Ç–æ —Å Extra Delivery #" ~ (extra_index + 1) %}
          {% set stage = "extra_delivery" %}
        {% endif %}

        <div class="card mb-2">
          <div class="card-header d-flex justify-content-between align-items-center" role="button"
              data-bs-toggle="collapse"
              data-bs-target="#photosCollapse-{{ stop_number }}"
              aria-expanded="false"
              aria-controls="photosCollapse-{{ stop_number }}"
              onclick="loadStagePhotos('{{ load_id }}', '{{ stage }}', {{ stop_number }})">
            <span>üñºÔ∏è {{ label }}</span>
            {# –ö–Ω–æ–ø–∫—É –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –∏–ª–∏ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, –µ—Å–ª–∏ —Ñ–æ—Ç–æ —Å –≤–µ–±–∞ –±–æ–ª—å—à–µ –Ω–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è #}
            {# <button class="btn btn-sm btn-primary"
                    onclick="event.stopPropagation(); openPhotoUploadModal('{{ load_id }}', '{{ stage }}', {{ stop_number }})">
              –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ
            </button> #}
          </div>
          <div id="photosCollapse-{{ stop_number }}" class="collapse">
            <div class="card-body">
              <div id="{{ stage }}PhotosContainer-{{ stop_number }}">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
          </div>
        </div>
      {% endfor %}


        <!-- –°–∫—Ä—ã—Ç—ã–π –±–ª–æ–∫ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ is_super_dispatch_order -->
        <div id="photoData"
            data-load-id="{{ load_id }}"
            data-is-super-dispatch="{{ 'true' if load.is_super_dispatch_order else 'false' }}"
            style="display: none;"></div>

        <!-- –ú–æ–¥–∞–ª–∫–∞ —Å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º —Ñ–æ—Ç–æ -->
        <div class="modal fade" id="photoPreviewModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content bg-dark position-relative">
              <div class="modal-body text-center">
                <img id="modalPhoto" src="" class="img-fluid rounded" style="max-height: 90vh;">
              </div>

              <!-- –õ–µ–≤–∞—è –∫–Ω–æ–ø–∫–∞ -->
              <button class="btn btn-secondary position-absolute top-50 start-0 translate-middle-y"
                      style="z-index: 1051;" onclick="prevPhoto()">
                ‚óÄ
              </button>

              <!-- –ü—Ä–∞–≤–∞—è –∫–Ω–æ–ø–∫–∞ -->
              <button class="btn btn-secondary position-absolute top-50 end-0 translate-middle-y"
                      style="z-index: 1051;" onclick="nextPhoto()">
                ‚ñ∂
              </button>
            </div>
          </div>
        </div>