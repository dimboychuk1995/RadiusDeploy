<h1>Детали водителя</h1>

<!-- Кнопка Назад -->
<button type="button" class="btn btn-secondary mb-3" id="backToDriversBtn">
  ← Назад к списку водителей
</button>

<div class="container-fluid">
  <div class="row">
    <!-- Левая колонка -->
    <div class="col-md-6">
      <!-- Основная информация -->
      <div class="card mb-4">
        <div class="card-header">Основная информация</div>
        <div class="card-body">
          <p><strong>Имя:</strong> {{ driver.name }}</p>
          <p><strong>Телефон:</strong> {{ driver.contact_number }}</p>
          <p><strong>Адрес:</strong> {{ driver.address }}</p>
          <p><strong>Email:</strong> {{ driver.email }}</p>
          <p><strong>Дата рождения:</strong> {{ driver.dob }}</p>
          <p><strong>Тип водителя:</strong> {{ driver.driver_type }}</p>
          <p><strong>Статус:</strong> {{ driver.status or "—" }}</p>
        </div>
      </div>

      <!-- Привязки -->
      <div class="card mb-4">
        <div class="card-header">Привязки</div>
        <div class="card-body">
          <p><strong>Трак:</strong> {% if truck %}{{ truck.unit_number }} - {{ truck.make }} {{ truck.model }}{% else %}Нет{% endif %}</p>
          <p><strong>Диспетчер:</strong> {% if dispatcher %}{{ dispatcher.username }}{% else %}Нет{% endif %}</p>
        </div>
      </div>
    </div>

    <!-- Правая колонка -->
    <div class="col-md-6">
      <!-- Лицензия -->
      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span class="fw-bold"><i data-lucide="id-card" class="me-2"></i>Информация о лицензии</span>
          <button class="btn btn-sm btn-outline-primary toggle-btn" type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#collapseLicense"
                  aria-expanded="false"
                  aria-controls="collapseLicense">
            <i data-lucide="chevron-down"></i>
          </button>
        </div>
        <div id="collapseLicense" class="collapse">
          <div class="card-body">
            <p><strong>Номер:</strong> {{ driver.license.number }}</p>
            <p><strong>Класс:</strong> {{ driver.license.class }}</p>
            <p><strong>Штат:</strong> {{ driver.license.state }}</p>
            <p><strong>Адрес:</strong> {{ driver.license.address }}</p>
            <p><strong>Дата выдачи:</strong> {{ driver.license.issued_date }}</p>
            <p><strong>Дата окончания:</strong> {{ driver.license.expiration_date }}</p>
            <p><strong>Ограничения:</strong> {{ driver.license.restrictions }}</p>

            <div class="file-preview collapse-loader mt-3"
                 data-driver-id="{{ driver._id }}"
                 data-doc="license">
              <div class="spinner-border text-primary small-spinner d-none" role="status"></div>
              <div class="file-content mt-3"></div>
            </div>

          </div>
        </div>
      </div>

      <!-- Медкарта -->
      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span class="fw-bold"><i data-lucide="stethoscope" class="me-2"></i>Медицинский сертификат</span>
          <button class="btn btn-sm btn-outline-primary toggle-btn" type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#collapseMed"
                  aria-expanded="false"
                  aria-controls="collapseMed">
            <i data-lucide="chevron-down"></i>
          </button>
        </div>
        <div id="collapseMed" class="collapse">
          <div class="card-body">
            <p><strong>Дата выдачи:</strong> {{ driver.medical_card.issued_date }}</p>
            <p><strong>Дата окончания:</strong> {{ driver.medical_card.expiration_date }}</p>
            <p><strong>Ограничения:</strong> {{ driver.medical_card.restrictions }}</p>

            <div class="file-preview collapse-loader mt-3"
                 data-driver-id="{{ driver._id }}"
                 data-doc="medical_card">
              <div class="spinner-border text-primary small-spinner d-none" role="status"></div>
              <div class="file-content mt-3"></div>
            </div>

          </div>
        </div>
      </div>

      <!-- Драг тест -->
      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span class="fw-bold"><i data-lucide="flask-conical" class="me-2"></i>Драг тест</span>
          <button class="btn btn-sm btn-outline-primary toggle-btn" type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#collapseDrug"
                  aria-expanded="false"
                  aria-controls="collapseDrug">
            <i data-lucide="chevron-down"></i>
          </button>
        </div>
        <div id="collapseDrug" class="collapse">
          <div class="card-body">
            <p><strong>Дата теста:</strong> {{ driver.drug_test.issued_date }}</p>

            <div class="file-preview collapse-loader mt-3"
                 data-driver-id="{{ driver._id }}"
                 data-doc="drug_test">
              <div class="spinner-border text-primary small-spinner d-none" role="status"></div>
              <div class="file-content mt-3"></div>
            </div>

          </div>
        </div>
      </div>

      <!-- MVR -->
        <div class="card mb-3">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span class="fw-bold"><i data-lucide="shield-check" class="me-2"></i>MVR</span>
            <button class="btn btn-sm btn-outline-primary toggle-btn" type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapseMVR"
                    aria-expanded="false"
                    aria-controls="collapseMVR">
              <i data-lucide="chevron-down"></i>
            </button>
          </div>
          <div id="collapseMVR" class="collapse">
            <div class="card-body">
              <p><strong>Дата окончания:</strong> {{ driver.mvr.expiration_date }}</p>

                <div class="file-preview collapse-loader mt-3"
                     data-driver-id="{{ driver._id }}"
                     data-doc="mvr">
                  <div class="spinner-border text-primary small-spinner d-none" role="status"></div>
                  <div class="file-content mt-3"></div>
                </div>

            </div>
          </div>
        </div>

        <!-- PSP -->
        <div class="card mb-3">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span class="fw-bold"><i data-lucide="file-text" class="me-2"></i>PSP</span>
            <button class="btn btn-sm btn-outline-primary toggle-btn" type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapsePSP"
                    aria-expanded="false"
                    aria-controls="collapsePSP">
              <i data-lucide="chevron-down"></i>
            </button>
          </div>
          <div id="collapsePSP" class="collapse">
            <div class="card-body">

                <div class="file-preview collapse-loader mt-3"
                     data-driver-id="{{ driver._id }}"
                     data-doc="psp">
                  <div class="spinner-border text-primary small-spinner d-none" role="status"></div>
                  <div class="file-content mt-3"></div>
                </div>

            </div>
          </div>
        </div>

        <!-- Clearing House -->
        <div class="card mb-3">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span class="fw-bold"><i data-lucide="database" class="me-2"></i>Clearing House</span>
            <button class="btn btn-sm btn-outline-primary toggle-btn" type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapseCH"
                    aria-expanded="false"
                    aria-controls="collapseCH">
              <i data-lucide="chevron-down"></i>
            </button>
          </div>
          <div id="collapseCH" class="collapse">
            <div class="card-body">

                <div class="file-preview collapse-loader mt-3"
                     data-driver-id="{{ driver._id }}"
                     data-doc="clearing_house">
                  <div class="spinner-border text-primary small-spinner d-none" role="status"></div>
                  <div class="file-content mt-3"></div>
                </div>

            </div>
          </div>
        </div>

        <!-- Agreement -->
        <div class="card mb-3">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span class="fw-bold"><i data-lucide="file-signature" class="me-2"></i>Agreement</span>
            <button class="btn btn-sm btn-outline-primary toggle-btn" type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapseAgreement"
                    aria-expanded="false"
                    aria-controls="collapseAgreement">
              <i data-lucide="chevron-down"></i>
            </button>
          </div>
          <div id="collapseAgreement" class="collapse">
            <div class="card-body">

                <div class="file-preview collapse-loader mt-3"
                     data-driver-id="{{ driver._id }}"
                     data-doc="agreement">
                  <div class="spinner-border text-primary small-spinner d-none" role="status"></div>
                  <div class="file-content mt-3"></div>
                </div>

            </div>
          </div>
        </div>

        <!-- SSN -->
        <div class="card mb-3">
          <div class="card-header"><strong><i data-lucide="hash" class="me-2"></i>SSN</strong></div>
          <div class="card-body">
            <p><strong>Номер:</strong> {{ driver.ssn or "—" }}</p>
          </div>
        </div>



    </div>
  </div>
</div>


<!-- Кнопка схемы зарплаты -->
<button type="button" class="btn btn-info mt-3" onclick="openSalaryModal()">💰 Схема зарплаты</button>



<!-- 💼 Модалка зарплаты -->
<div class="custom-offcanvas custom-offcanvas-right" id="salarySchemeModal">
  <div class="custom-offcanvas-content">
    <div class="custom-offcanvas-header">
      <h5 class="modal-title">Настройка схемы зарплаты</h5>
      <button type="button" class="close" onclick="closeSalaryModal()">
        <span>&times;</span>
      </button>
    </div>
    <div class="custom-offcanvas-body">
      <form id="salarySchemeForm" data-driver-id="{{ driver._id }}">
        <div class="form-group">
          <label>Схема расчёта</label>
          <select class="form-control" name="scheme_type" id="schemeTypeSelect">
            <option value="percent" {% if scheme_data.scheme_type == 'percent' %}selected{% endif %}>Процент от суммы грузов</option>
            <option value="net_percent" {% if scheme_data.scheme_type == 'net_percent' %}selected{% endif %}>Процент от чистой прибыли</option>
            <option value="per_mile" {% if scheme_data.scheme_type == 'per_mile' %}selected{% endif %}>Фиксированная ставка за милю</option>
          </select>
        </div>

        <div id="percentSchemeBlock" {% if scheme_data.scheme_type != 'percent' %}style="display: none;"{% endif %}>
          <div class="form-group">
            <label>Базовый процент от $0:</label>
            <input type="number" step="0.01" name="base_percent" class="form-control"
                   value="{{ scheme_data.commission_table[0].percent if scheme_data.commission_table and scheme_data.commission_table[0].from_sum == 0 else 30 }}">
          </div>
          <label>Дополнительные уровни:</label>
          <div id="commissionTable">
            {% for entry in scheme_data.commission_table[1:] %}
            <div class="form-row mb-2">
              <div class="col"><input type="number" step="0.01" class="form-control" name="gross_from_sum[]" value="{{ entry.from_sum }}" placeholder="от суммы ($)"></div>
              <div class="col"><input type="number" step="0.01" class="form-control" name="gross_percent[]" value="{{ entry.percent }}" placeholder="Процент (%)"></div>
            </div>
            {% endfor %}
          </div>
          <button type="button" class="btn btn-sm btn-outline-secondary" id="addCommissionRow">+ Добавить строку</button>
        </div>

        <div id="perMileBlock" {% if scheme_data.scheme_type != 'per_mile' %}style="display: none;"{% endif %}>
          <div class="form-group">
            <label>Ставка за милю ($):</label>
            <input type="number" step="0.01" name="per_mile_rate" class="form-control"
                   value="{{ scheme_data.per_mile_rate or '' }}" placeholder="например: 0.65">
          </div>
        </div>

        <div id="netPercentBlock" {% if scheme_data.scheme_type == 'percent' %}style="display: none;"{% endif %}>
          <div class="form-group">
            <label>Базовый процент от $0:</label>
            <input type="number" step="0.01" name="base_percent" class="form-control"
                   value="{{ scheme_data.net_commission_table[0].percent if scheme_data.net_commission_table and scheme_data.net_commission_table[0].from_sum == 0 else 30 }}">
          </div>
          <label>Дополнительные уровни:</label>
          <div id="netCommissionTable">
            {% for entry in scheme_data.net_commission_table[1:] %}
            <div class="form-row mb-2">
              <div class="col"><input type="number" step="0.01" class="form-control" name="net_from_sum[]" value="{{ entry.from_sum }}" placeholder="от суммы ($)"></div>
              <div class="col"><input type="number" step="0.01" class="form-control" name="net_percent[]" value="{{ entry.percent }}" placeholder="Процент (%)"></div>
            </div>
            {% endfor %}
          </div>
          <button type="button" class="btn btn-sm btn-outline-secondary" id="addNetCommissionRow">+ Добавить строку</button>
        </div>

        <hr>
        <h5>✅ Clean Inspection Bonus</h5>
        <div class="form-group form-check">
          <input type="checkbox" class="form-check-input" id="enableInspectionBonus" name="enable_inspection_bonus" {% if scheme_data.enable_inspection_bonus %}checked{% endif %}>
          <label class="form-check-label" for="enableInspectionBonus">Включить бонус за чистую инспекцию</label>
        </div>

        <div id="inspectionBonusBlock" {% if not scheme_data.enable_inspection_bonus %}style="display: none;"{% endif %}>
          <div class="form-group">
            <label>Level 1 ($):</label>
            <input type="number" step="0.01" name="bonus_level_1" class="form-control" value="{{ scheme_data.bonus_level_1 or '' }}">
          </div>
          <div class="form-group">
            <label>Level 2 ($):</label>
            <input type="number" step="0.01" name="bonus_level_2" class="form-control" value="{{ scheme_data.bonus_level_2 or '' }}">
          </div>
          <div class="form-group">
            <label>Level 3 ($):</label>
            <input type="number" step="0.01" name="bonus_level_3" class="form-control" value="{{ scheme_data.bonus_level_3 or '' }}">
          </div>
        </div>

        <!-- 🆕 Extra Stop Bonus -->
        <hr>
        <h5>🛑 Extra Stop Bonus</h5>
        <div class="form-group form-check">
          <input type="checkbox" class="form-check-input" id="enableExtraStopBonus" name="enable_extra_stop_bonus" {% if scheme_data.enable_extra_stop_bonus %}checked{% endif %}>
          <label class="form-check-label" for="enableExtraStopBonus">Включить бонус за каждый extra stop</label>
        </div>
        <div id="extraStopBonusBlock" {% if not scheme_data.enable_extra_stop_bonus %}style="display: none;"{% endif %}>
          <div class="form-group">
            <label>Сумма за 1 extra stop ($):</label>
            <input type="number" step="0.01" name="extra_stop_bonus_amount" class="form-control" value="{{ scheme_data.extra_stop_bonus_amount or '' }}" placeholder="например: 25">
          </div>
        </div>

        <hr>
        <h5>➕ Additional Charges</h5>
        <div id="additionalChargesContainer">
          {% for charge in scheme_data.additional_charges %}
          <div class="border p-3 mb-3 rounded bg-light">
            <div class="form-group">
              <label>Тип списания:</label>
              <input type="text" name="charge_type[]" class="form-control" value="{{ charge.type }}">
            </div>

            <div class="form-group">
              <label>Период:</label>
              <select name="charge_period[]" class="form-control period-select">
                <option value="statement" {% if charge.period == 'statement' %}selected{% endif %}>Каждый стейтмент</option>
                <option value="monthly" {% if charge.period == 'monthly' %}selected{% endif %}>Раз в месяц</option>
              </select>
            </div>

            <div class="form-group date-group {% if charge.period != 'monthly' %}d-none{% endif %}">
              <label>Число месяца:</label>
              <input type="number" name="charge_day_of_month[]" class="form-control" value="{{ charge.day_of_month or '' }}">
            </div>

            <div class="form-group">
              <label>Файл:</label>
              <input type="file" name="charge_file[]" class="form-control-file">
              {% if charge.file %}
              <small class="form-text text-muted">Загружено: {{ charge.file.filename }}</small>
              {% endif %}
            </div>

            <div class="form-group">
              <label>Сумма ($):</label>
              <input type="number" step="0.01" name="charge_amount[]" class="form-control" value="{{ charge.amount }}">
            </div>
          </div>
          {% endfor %}
        </div>
        <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="addChargeBtn">+ Добавить списание</button>

        <div class="mt-4 d-flex justify-content-end">
          <button type="button" class="btn btn-secondary mr-2" onclick="closeSalaryModal()">Отмена</button>
          <button type="submit" class="btn btn-primary">Сохранить схему</button>
        </div>
      </form>
    </div>
  </div>
</div>
<div class="custom-offcanvas-backdrop" onclick="closeSalaryModal()"></div>
