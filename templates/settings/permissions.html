<div class="p-3" id="perm-root" data-mode="roles">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h5 class="mb-0">
      <i class="fas fa-user-shield me-2"></i> Permissions
    </h5>
    <div class="d-flex align-items-center gap-2">
      <!-- Переключатель режима -->
      <div class="btn-group" role="group" aria-label="Mode">
        <button type="button" class="btn btn-outline-secondary" id="modeRolesBtn" data-mode="roles">Roles</button>
        <button type="button" class="btn btn-outline-secondary" id="modeUserBtn" data-mode="user">User</button>
      </div>

      <!-- Select2: выбор пользователя -->
      <div id="userPicker" class="d-flex align-items-center gap-2 d-none">
        <select id="userSelect" class="form-select form-select-sm" style="min-width: 320px;">
          <option value="">Select user…</option>
        </select>
      </div>

      <button id="btnPermSave" class="btn btn-primary">
        <i class="fas fa-save me-1"></i> Save
      </button>
    </div>
  </div>

  <div class="alert alert-light border d-flex align-items-center gap-3 py-2">
    <div><strong>Mode:</strong> <span id="modeLabel">Roles</span></div>
    <div class="small text-muted">
      <span class="me-3">Roles → меняем права для роли.</span>
      <span>User → выбираем пользователя, итог = роль + его override. Клик: allow → deny → убрать override.</span>
    </div>
  </div>

  {% if categories|length == 0 %}
    <div class="alert alert-warning">Каталог прав пуст. Проверьте <code>permission_defs</code>.</div>
  {% else %}

    <!-- Segmented tabs (категории) -->
    <div class="segmented mb-3" id="perm-tabs" role="tablist" aria-label="Permission categories">
      {% for cat in categories %}
        <button type="button"
                class="perm-tab seg-item {% if loop.first %}active{% endif %}"
                data-target="cat-{{ loop.index0 }}">
          {{ cat.category }}
        </button>
      {% endfor %}
    </div>

    <!-- ОБЁРТКА ДЛЯ ПЛАВНОЙ АНИМАЦИИ ВЫСОТЫ -->
    <div id="perm-cats">
      <!-- Category tables -->
      {% for cat in categories %}
      <div class="perm-cat {% if not loop.first %}d-none{% endif %}" id="cat-{{ loop.index0 }}">
        <div class="table-responsive" id="perm-table-wrapper">
          <table class="table table-hover align-middle">
            <thead>
              <tr class="perm-sticky-head">
                <th class="perm-function perm-sticky-first">Function</th>

                <!-- столбцы ролей (режим Roles) -->
                {% for r in roles %}
                  <th class="role-col">
                    <span class="badge perm-badge-role text-wrap">{{ r }}</span>
                  </th>
                {% endfor %}

                <!-- пустая шапка для выравнивания user-колонки -->
                <th class="user-col-head d-none"></th>
              </tr>
            </thead>
            <tbody>
              {% for grp in cat.groups %}
                <tr class="perm-group-row">
                  <td class="perm-sticky-first" colspan="{{ 1 + roles|length + 1 }}">
                    <span class="me-2">›</span> {{ grp.group }} ({{ grp['items']|length }})
                  </td>
                </tr>

                {% for item in grp['items'] %}
                  <tr>
                    <td class="perm-sticky-first">
                      <span class="perm-label" data-slug="{{ item.slug }}">{{ item.label }}</span>
                    </td>

                    <!-- клетки РОЛЕЙ -->
                    {% for r in roles %}
                      {% set caps = role_caps.get(r, []) %}
                      {% set has = (item.slug in caps) or ('*' in caps) %}
                      <td class="perm-cell text-center role-col"
                          role="button"
                          tabindex="0"
                          aria-pressed="{{ 'true' if has else 'false' }}"
                          data-role="{{ r }}"
                          data-slug="{{ item.slug }}"
                          data-has="{{ 1 if has else 0 }}">
                        {% if has %}
                          <svg class="perm-ico perm-check" viewBox="0 0 24 24" aria-hidden="true">
                            <polyline points="4 12 9 17 20 6" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="square" stroke-linejoin="miter" />
                          </svg>
                        {% else %}
                          <svg class="perm-ico perm-cross" viewBox="0 0 24 24" aria-hidden="true">
                            <line x1="5" y1="5" x2="19" y2="19" stroke="currentColor" stroke-width="3" stroke-linecap="square" />
                            <line x1="19" y1="5" x2="5" y2="19" stroke="currentColor" stroke-width="3" stroke-linecap="square" />
                          </svg>
                        {% endif %}
                      </td>
                    {% endfor %}

                    <!-- единый столбец для User (JS сам поставит SVG) -->
                    <td class="perm-cell text-center user-col d-none"
                        role="button"
                        tabindex="0"
                        data-slug="{{ item.slug }}"
                        data-u=""
                        data-eff="">
                    </td>
                  </tr>
                {% endfor %}
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endfor %}
    </div><!-- /#perm-cats -->
  {% endif %}
</div>

<!-- Select2 (CDN) -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="{{ url_for('static', filename='js/settings_permissions.js') }}"></script>
